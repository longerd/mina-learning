# Block Producers

在 Mina 网络中, 区块生成者的角色是达成 [consensus](https://minaprotocol.com/blog/what-is-ouroboros-samasika) 并为区块链提供安全性保障. 区块生成者负责创建新的区块, 这些区块要包含网络上广播的近期交易以及能证明链当前状态有效的区块链证明. 

在 Mina 网络中, 任何人都可以成为区块生成者. 参与者数量没有限制, 其生成区块的机会与所质押的资金成正比. 资金不会被锁定, 也不会面临罚没风险. 

作为质押资金并生成所需区块链证明的回报, 被纳入主链的区块生成者所生成的区块会以 coinbase 和交易手续费的形式获得奖励, 不过要扣除为购买所需的 [transaction SNARK work](./snark-workers) 所支付的费用. 

要成功生成一个区块, 区块生成者必须有区块链的当前状态. 区块生成者必须有足够可用的计算资源, 以便在 slot 时间内生成区块链 SNARK, 并且要与其他节点保持连接, 以便能在网络共识参数所规定的可接受延迟范围内广播生成的区块. 

### Select a block producer

某个 slot 生成区块的机会由 [verifiable random function](./glossary#verifiable-random-function-vrf) 来决定. 可以把这个函数想象成彩票. 每个区块生成者针对每个 slot 独立运行这个可验证随机函数, 如果输出大于与生成者质押资金成正比的阈值, 他们就有机会在指定的 slot 生成区块. 

这个过程是保密的, 只有私钥持有者才能确定可验证随机函数的输出, 也只有他们自己知道何时要生成区块. 这种选择过程有助于保障安全性, 因为对手不可能针对某个特定 slot 的已知区块生成者发动攻击, 例如通过拒绝服务攻击或定向攻击等方式. 因此, 同一个 slot 可能会选出多个生成者. 当多个生成者针对同一个 slot 生成了有效的区块时, 就会产生 short-range 分叉, 此时共识规则会选择最长的链. 

质押分布是根据 "current epoch-2" 的最后一个区块的 SNARKed 账本确定的, 所以对于任何近期获取或 [delegated stake](#stake-delegation) 的情况会存在一定延迟. 例如, 如果当前 epoch 是10, 那么质押分布就是根据 epoch 8 最后一个区块的 SNARKed 账本确定的. 

要查看日志中 VRF 的输出, 可查找"Checking VRF evaluations".  

### Generating a block

当一个区块生成者被选中在某个 slot 生成区块时, 他们会执行以下操作: 

- 从他们的 transition frontier(本地存储的区块)中选择当前最佳链头, 以此为基础构建新区块. 

- 从交易池和 SNARK 池中选择交易以及所需的 SNARK 工作. 

    区块生成者添加到区块中的 SNARK 工作数量至少要与交易数量相等. 除了用户交易之外, 区块生成者还必须添加一笔 coinbase 交易(作为生成区块的奖励)以及任何用于支付 SNARK worker 的费用转移交易. 

- 生成区块链的拟定下一个状态.

    - 创建一个暂存账本的差异数据, 包含账户账本和扫描状态(一个有待生成证明的交易队列). 
    - 将这个差异数据应用到现有的暂存账本上, 以生成新的状态. 

- 创建一个区块链证明, 用以证明新状态是有效的. 

    这个 SNARK 还会额外验证先前的协议状态生成的证明. 

- 创建一个增量转换链证明, 用于证明如果在网络共识参数所规定的可接受网络延迟范围内接收到该区块, 那么这个区块就是有效的. 

- 在本地应用这个新生成的状态, 并将其添加到现有的 transition frontier. 

- 广播这个区块(call an external transition)给其他节点. 

### Stake delegation

委托的资金不可用于支出, 并且可以随时通过将质押重新委托回原始账户的方式取消委托. 